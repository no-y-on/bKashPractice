<!DOCTYPE html>
<html>
<head>
	<title>bKash PGW</title>
	<script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
                    crossorigin="anonymous"></script>
    <script src="https://scripts.sandbox.bka.sh/versions/1.1.0-beta/checkout/bKash-checkout-sandbox.js"></script>
	<link href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.0/css/bootstrap.min.css" rel="stylesheet" id="bootstrap-css">
	<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.0/js/bootstrap.min.js"></script>
	<script src="//code.jquery.com/jquery-1.11.1.min.js"></script>
	<style type="text/css">
		.paymentWrap {
			padding: 50px;
		}

		.paymentWrap .paymentBtnGroup {
			max-width: 800px;
			margin: auto;
		}

		.paymentWrap .paymentBtnGroup .paymentMethod {
			padding: 40px;
			box-shadow: none;
			position: relative;
		}

		.paymentWrap .paymentBtnGroup .paymentMethod.active {
			outline: none !important;
		}

		.paymentWrap .paymentBtnGroup .paymentMethod.active .method {
			border-color: #4cd264;
			outline: none !important;
			box-shadow: 0px 3px 22px 0px #7b7b7b;
		}

		.paymentWrap .paymentBtnGroup .paymentMethod .method {
			position: absolute;
			right: 3px;
			top: 3px;
			bottom: 3px;
			left: 3px;
			background-size: contain;
			background-position: center;
			background-repeat: no-repeat;
			border: 2px solid transparent;
			transition: all 0.5s;
		}
	</style>
</head>
<body>

<div class="container">
	<div class="row">
		<div class="paymentCont">
			<div class="headingWrap">
					<h3 class="headingTop text-center">Select Your Payment Method</h3>	
					<p class="text-center">Created with bootsrap button and using radio button</p>
			</div>
			<div class="paymentWrap">
				<div class="btn-group paymentBtnGroup btn-group-justified" data-toggle="buttons" id="dvpaywithbkash">

                    <fieldset class="item-details-layout">
                            <div class="button-div">
                                <button id="bKash_button" class="btn btn-primary btn-sm">Pay With bKas</button>
                                <div id="bKashFrameWrapper">
                                	<iframe id="bKash-iFrame-781" frameborder="0" src="https://client.sandbox.bka.sh/checkout/2" name="bKash_checkout_app" style=" display: none; border: none; margin: 0; padding: 0; height: 100%; width: 100%; -webkit-transform: translate3d(0, 0, 0);">
                                	</iframe>
                                </div>
                            </div>
                        </div>
                    </fieldset>		         
		        </div>        
			</div>
			<div class="footerNavWrap clearfix">
				<div class="btn btn-success pull-left btn-fyi"><span class="glyphicon glyphicon-chevron-left"></span> CONTINUE SHOPPING</div>
				<div class="btn btn-success pull-right btn-fyi">CHECKOUT<span class="glyphicon glyphicon-chevron-right"></span></div>
			</div>
		</div>
	</div>
</div>
</body>
<script type="text/javascript">
	$(document).on('click','#bKash_button',function(){
		console.log('Hello');
		initBkash();
	});


	let paymentID;

	let username = "Your username"; // New line
	let password = "Your password"; // New line
	let app_key = "Your app key"; // New line
	let app_secret = "Your app secret"; // New line

	let grantTokenUrl = 'https://checkout.sandbox.bka.sh/v1.2.0-beta/checkout/token/grant'; // New line
	let createCheckoutUrl = 'https://checkout.sandbox.bka.sh/v1.2.0-beta/checkout/payment/create'; // Replaced API
	let executeCheckoutUrl = 'https://checkout.sandbox.bka.sh/v1.2.0-beta/checkout/payment/execute'; // Replaced API

	$(document).ready(function () {
	    getAuthToken(); // Replaced function
	});

	// New function
	function getAuthToken() {
	    let body = {
	      "app_key": app_key,
	      "app_secret": app_secret
	    };

	    $.ajax({
	      url: grantTokenUrl,
	      headers: {
	        "username": username,
	        "password": password,
	        "Content-Type": "application/json"
	      },
	      type: 'POST',
	      data: JSON.stringify(body),
	      success: function (result) {
	          
	        let headers = {
	          "Content-Type": "application/json",
	          "Authorization": result.id_token, // Contains access token
	          "X-APP-Key": app_key
	        };

	        let request = {
	            "amount": "85.50",
	            "intent": "sale",
	            "currency": "BDT", // New line
	            "merchantInvoiceNumber": "123456" // New line
	        };

	        initBkash(headers, request);
	      },
	      error: function (error) {
	        console.log(error);
	      }
	    });
	}

	function initBkash(headers, request) {
	    bKash.init({
	      paymentMode: 'checkout',
	      paymentRequest: request, // Updated line

	      createRequest: function (request) {
	        $.ajax({
	          url: createCheckoutUrl,
	          headers: headers, // New line
	          type: 'POST',
	          contentType: 'application/json',
	          data: JSON.stringify(request),
	          success: function (data) {
	              
	            if (data && data.paymentID != null) {
	              paymentID = data.paymentID;
	              bKash.create().onSuccess(data);
	            } 
	            else {
	              bKash.create().onError(); // Run clean up code
	              alert(data.errorMessage + " Tag should be 2 digit, Length should be 2 digit, Value should be number of character mention in Length, ex. MI041234 , supported tags are MI, MW, RF");
	            }

	          },
	          error: function () {
	            bKash.create().onError(); // Run clean up code
	            alert(data.errorMessage);
	          }
	        });
	      },
	      executeRequestOnAuthorization: function () {
	        $.ajax({
	          url: executeCheckoutUrl + '/' + paymentID, // Updated line
	          headers: headers, // New line
	          type: 'POST',
	          contentType: 'application/json',
	          success: function (data) {

	            if (data && data.paymentID != null) {
	              // On success, perform your desired action
	              alert('[SUCCESS] data : ' + JSON.stringify(data));
	              window.location.href = "/success_page.html";

	            } else {
	              alert('[ERROR] data : ' + JSON.stringify(data));
	              bKash.execute().onError();//run clean up code
	            }

	          },
	          error: function () {
	            alert('An alert has occurred during execute');
	            bKash.execute().onError(); // Run clean up code
	          }
	        });
	      },
	      onClose: function () {
	        alert('User has clicked the close button');
	      }
	    });

	    $('#bKash_button').removeAttr('disabled');

	}

</script>
</html>